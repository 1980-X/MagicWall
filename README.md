# MagicWall

## 项目简介
MagicWall 是一个完全独立的 Windows 桌面原生应用程序，设计用于 9.05 米 × 1.80 米的物理展示屏幕。该应用允许用户通过点击按钮或热点区域切换页面，并在正常状态下展示循环滚动的动画效果。应用启动时会提示用户选择模式，以便适应不同的使用场景。**本应用不依赖任何浏览器环境，无需安装浏览器，也不需要通过浏览器进行调试，直接运行程序即可使用。**

## 功能特点
- **独立原生应用**：Windows 平台原生应用，完全不依赖任何浏览器环境和浏览器调试工具
- **交互切换**：通过点击按钮或热点区域实现页面切换
- **动画效果**：页面上的小动画循环滚动播放
- **双模式支持**：提供调试模式和产品模式，适应不同场景需求，且两种模式下保持完全一致的视觉和交互体验
- **多模式展示**：包含六个不同的展示模式，分别对应不同的管理部门和功能需求

## 双模式支持
应用提供两种运行模式，以满足不同场景的需求，且确保两种模式下窗口比例、内部布局、图文内容和动画效果保持完全一致性。我们通过以下技术实现确保这种一致性：

### 核心技术实现
1. **统一的模式配置系统**：在 `src/js/mode.js` 中维护统一的模式配置，包括不同模式下的屏幕尺寸、默认模式等参数
2. **响应式布局设计**：所有UI元素使用相对单位（百分比）而非固定像素值，确保在不同尺寸下保持一致比例
3. **模式切换机制**：实现了平滑的模式切换逻辑，在切换时自动调整窗口大小并重新计算布局
4. **布局验证器**：开发了专门的布局验证工具，在开发环境中自动检测并报告布局不一致问题
5. **统一的初始化流程**：确保无论哪种模式，应用都遵循相同的初始化流程，加载相同的资源和配置

### 技术改进历程
1. **日志系统优化**：修复了 `logToMainProcess` 函数的参数传递问题，确保日志信息能正确显示在终端
2. **默认模式修正**：将默认模式从 `debug` 改为 `production`，确保应用默认以产品模式启动
3. **开发环境布局验证**：增强了开发环境下的布局验证逻辑，确保开发过程中就能发现并解决布局一致性问题
4. **窗口尺寸优化**：调整了产品模式下的窗口尺寸参数，使其更适合在开发环境中进行测试，同时保持正确的宽高比例
5. **GIF动画持续循环播放优化**：
   - 实现了稳健的GIF动画重置机制，通过创建`isResetting`状态变量明确区分正常加载错误和重置过程中的错误
   - 采用Image对象预加载策略，减少对DOM元素的直接操作，避免触发不必要的错误事件
   - 添加5秒超时保护机制，防止加载和重置操作卡住
   - 优化状态管理一致性，确保所有异常路径中状态变量都被正确重置
   - 设计备用加载策略，在主要方法失败时自动切换到备用方案
   - 增加重试间隔和重置间隔，减少操作频率，提高系统稳定性
   - **解决了"播放一次就停"的关键问题**：通过修复事件绑定时序，确保GIF动画能够持续循环播放
   - 实现了智能状态检查机制，区分初始加载和重置加载，避免状态冲突
   - 采用延迟设置src属性的策略，确保事件绑定完成后再开始加载

### 运行模式详细说明

### 调试模式
专为开发人员设计，用于日常开发、调试和画面效果确认。此模式下：
- 窗口尺寸会根据开发者屏幕的宽度动态计算，保持与物理屏幕相同的比例（9.05米 × 1.80米）
- 新的实现逻辑：直接检测当前主机屏幕的宽度，预留10%边距作为可用宽度，再根据固定比例(5.028)计算高度
- 如果计算出的高度超过屏幕可用高度，则以屏幕高度为准重新计算宽度，确保始终保持正确比例
- 窗口尺寸自动缩放到产品模式的70%，便于在普通电脑屏幕上查看
- 可在普通电脑屏幕上运行，无需依赖特定硬件
- **保持与产品模式完全一致的窗口比例、内部布局、图文内容和动画效果**
- 可选启用开发者工具（通过环境变量控制）

### 产品模式
针对 9.05m × 1.80m 大型物理展示屏幕优化的最终展示模式：
- **智能窗口尺寸计算**：直接检测当前主机屏幕的宽度，预留10%边距作为可用宽度，再根据固定比例(5.028)计算高度
- 如果计算出的高度超过屏幕可用高度，则以屏幕高度为准重新计算宽度，确保始终保持正确比例
- 在生产环境下，窗口优先使用接近物理屏幕的尺寸（9050px × 1800px）
- 在开发环境下，为了方便测试，产品模式使用适合开发屏幕的尺寸，但保持相同的比例
- 移除所有调试相关功能，专注于最佳展示效果
- **保持与调试模式完全一致的窗口比例、内部布局、图文内容和动画效果**

**重要说明**：两种模式的核心区别仅在于窗口尺寸，**窗口比例、内部布局、图文内容和动画效果在两种模式下完全一致**。这确保了开发者在普通电脑上调试的效果与最终在物理屏幕上的展示效果完全一致，实现"所见即所得"的开发体验。
- **启动模式选择**：应用启动时会首先显示一个模式选择弹窗，用户需要通过该弹窗明确选择进入调试模式或产品模式。弹窗提供清晰的选项说明，帮助用户根据使用场景做出正确选择。选择后，应用将按照选定的模式进行初始化和显示。
- **无边框窗口**：应用窗口在所有模式下都不显示标准的标题栏（包含关闭、最小化、最大化按钮），提供更沉浸的用户体验
- **响应式设计**：在不同尺寸的屏幕上都能提供良好的用户体验
- **RS232 指令支持**：未来版本将实现通过 RS232 接口接收指令，根据指令内容动态呈现不同页面，增强系统的外部控制能力和集成性
- 窗口布局：主窗口采用分区设计，从左到右分为五个区域
  - 第一个区域为卷首语区，宽度约占总宽度的11.6%
  - 第二至第五个区域平均分布，每个区域宽度约占总宽度的22.1%
  - 实际像素比例参考：1050:2000:2000:2000:2000（从左到右）
  - 所有区域高度相同，均为窗口总高度
  - 布局采用响应式设计，**在调试模式和产品模式下保持完全一致的比例和布局结构**
  - 界面布局完全基于相对单位（百分比）而非绝对值，确保在任何模式和尺寸下都能精确保持设计比例

## 技术栈
- 框架：Electron.js
- 前端：HTML, CSS, JavaScript
- 构建工具：Electron Builder

## 项目结构
```
MagicWall/
├── README.md           # 项目说明文档
├── package.json        # 项目依赖配置
├── src/
│   ├── index.html      # 入口文件
│   ├── css/
│   │   └── styles.css  # 样式文件
│   ├── js/
│   │   ├── app.js      # 应用主逻辑
│   │   ├── mode.js     # 模式切换逻辑
│   │   └── animation.js # 动画效果实现
│   └── assets/         # 静态资源（图片、视频等）
└── dist/               # 构建输出目录
```

### assets 文件夹使用说明
`src/assets/` 文件夹用于存放应用的所有静态资源，包括图片、视频、音频等文件。为了更好地组织设计元素，我们创建了以下专用子文件夹：
- `images/`：存放所有图片资源（如背景图、装饰图等）
- `animations/`：存放所有动画资源（如GIF、SVG动画等）
- `text/`：存放文本内容相关的资源文件
- `icons/`：存放图标资源

在代码中引用这些资源时，请使用相对路径，例如：

```html
<img src="./assets/image.png" alt="示例图片">
```

```css
background-image: url('../assets/background.jpg');
```

请确保将所有静态资源文件放入此文件夹中，以便更好地组织和管理项目文件。

## 配置说明
在 `src/js/mode.js` 中可以配置两种模式的参数，主要包括：

```javascript
// 模式配置参数
module.exports.CONFIG = {
    // 物理屏幕尺寸 (9.05米 x 1.80米)
    PHYSICAL_SCREEN_WIDTH: 9050,  // 物理屏幕宽度，单位：像素
    PHYSICAL_SCREEN_HEIGHT: 1800, // 物理屏幕高度，单位：像素
    SCREEN_RATIO: 5.028,    // 9.05米 / 1.80米 的比例
    
    // 开发环境下使用的产品模式尺寸
    DEV_PRODUCTION_WIDTH: 1920,   // 开发环境下使用的宽度
    DEV_PRODUCTION_HEIGHT: 382,   // 开发环境下使用的高度
    
    // 调试模式下的基准高度
    DEBUG_BASE_HEIGHT: 600,
    
    // 默认模式设置
    DEFAULT_MODE: 'production',    // 'debug' 或 'production'
    
    // 自动模式切换阈值
    PRODUCTION_MODE_THRESHOLD_WIDTH: 8000, // 屏幕宽度超过此值时视为物理屏幕
    AUTO_MODE_ENABLED: true, // 是否启用自动模式检测
    
    // 开发环境标识
    IS_DEV_ENV: process.env.NODE_ENV !== 'production'
};
```

### 关键配置说明
- `PHYSICAL_SCREEN_WIDTH` 和 `PHYSICAL_SCREEN_HEIGHT`：物理屏幕的实际尺寸（像素）
- `DEV_PRODUCTION_WIDTH` 和 `DEV_PRODUCTION_HEIGHT`：开发环境下产品模式使用的尺寸
- `SCREEN_RATIO`：屏幕宽高比，保持所有模式下的一致性
- `DEBUG_BASE_HEIGHT`：调试模式下的基准高度（默认600px），用于计算理想宽度
- `IS_DEV_ENV`：标识当前是否为开发环境，用于决定产品模式下使用的尺寸

产品模式下的窗口尺寸会根据环境自动选择：
- 生产环境：使用物理屏幕尺寸 (9050px × 1800px)
- 开发环境：使用缩小的尺寸 (1920px × 382px)，但保持相同的比例

调试模式下的窗口尺寸会根据开发者屏幕宽度动态计算：
- 直接检测当前主机屏幕的宽度，预留10%边距作为可用宽度
- 根据固定比例(5.028)计算高度：高度 = 可用宽度 / 比例
- 如果计算出的高度超过屏幕可用高度，则以屏幕高度为准重新计算宽度，确保始终保持正确比例
- 窗口尺寸自动缩放到产品模式的70%，便于在普通电脑屏幕上查看

**注**：调试模式的界面窗口尺寸会严格按照产品模式的屏幕比例（9.05米 × 1.80米）进行缩放显示，以确保开发调试与最终展示效果的一致性。

## 环境变量
- `OPEN_DEV_TOOLS`: 控制在调试模式下是否打开开发者工具，默认为 `true`。设置为 `false` 可以在调试模式下不打开控制台。

## 六模式展示系统
本应用提供六个不同的展示模式，分别由卷首语区域的六个按钮控制。当用户按下一个按钮时，系统会切换出与当前模式相应的内容，包括卷首语区域的标题图、内文图以及四个内容区的相关信息。

### 模式列表
1. **应急管理委员会模式**：
   - 由卷首语区域的第一个按钮控制
   - 展示应急管理委员会的相关内容和信息
   - 适用于应急管理相关场景的展示

2. **防汛抗旱指挥部模式**：
   - 由卷首语区域的第二个按钮控制
   - 展示防汛抗旱指挥部的相关内容和信息
   - 适用于防汛抗旱相关场景的展示

3. **安全生产委员会模式**：
   - 由卷首语区域的第三个按钮控制
   - 展示安全生产委员会的相关内容和信息
   - 适用于安全生产相关场景的展示

4. **森林放灭火指挥部模式**：
   - 由卷首语区域的第四个按钮控制
   - 展示森林放灭火指挥部的相关内容和信息
   - 适用于森林火灾预防和扑救相关场景的展示

5. **减灾委员会模式**：
   - 由卷首语区域的第五个按钮控制
   - 展示减灾委员会的相关内容和信息
   - 适用于灾害预防和减轻相关场景的展示

6. **抗震救灾指挥部模式**：
   - 由卷首语区域的第六个按钮控制
   - 展示抗震救灾指挥部的相关内容和信息
   - 适用于地震灾害预防和应对相关场景的展示

### 模式切换机制
- 点击卷首语区域对应的按钮即可切换到相应模式
- 切换后，所有显示区域的内容会同步更新
- 每个模式下的内容都经过专门设计，确保信息准确、展示效果良好
- 模式切换过程平滑，无明显延迟

## 窗口比例与响应式设计
应用设计用于9.05米×1.80米的物理展示屏幕，具有精确的宽横屏比例（≈5.028）。为确保在不同模式和设备上的一致性体验，我们采用了以下设计原则：

### 比例保持机制
1. **屏幕比例计算**：9.05米 ÷ 1.80米 ≈ 5.028
2. **调试模式窗口尺寸**：默认高度600px，宽度按比例计算约为3017px
3. **产品模式窗口尺寸**：9050px × 1800px
4. **窗口比例保持**：应用会监听窗口大小变化事件，当用户调整窗口大小时，自动保持正确的屏幕比例
5. **屏幕适配**：应用会自动检测屏幕尺寸，如果窗口尺寸超出屏幕边界，会按比例缩小以适应屏幕

### 屏幕宽度检测与窗口高度自动计算功能
为实现更智能的窗口尺寸适配，应用支持基于当前屏幕宽度自动计算主窗口高度的功能：

1. **屏幕宽度获取**：应用启动时会自动获取当前显示设备的屏幕宽度
2. **高度自动计算**：根据既定的宽高比例（5.028），使用公式`窗口高度 = 屏幕宽度 ÷ 比例`自动计算出最合适的窗口高度
3. **自适应匹配**：确保主窗口尺寸与当前显示设备的物理特性实现最佳匹配，提供良好的视觉体验
4. **模式自适应**：可与自动模式切换功能结合，根据检测到的屏幕尺寸自动选择最合适的运行模式（调试模式或产品模式）

### 响应式布局技术方案
为确保在不同模式下内容布局的一致性，我们采用了以下技术方案：

1. **相对单位使用**：
   - 所有UI元素尺寸均使用相对单位（如百分比、vw、em）而非绝对像素值
   - 文字大小使用vw（视窗宽度单位），确保在不同屏幕尺寸下自动缩放
   - 间距和边距使用相对单位，确保在不同尺寸下保持比例关系

2. **弹性布局系统**：
   - 使用CSS Flexbox实现主容器的水平布局
   - 各区域宽度使用百分比设置（11.6%和22.1%），确保比例一致
   - 容器元素设置适当的flex属性，确保内容在不同宽度下正确流动

3. **媒体查询**：
   - 根据屏幕尺寸和比例应用不同的样式规则
   - 使用媒体查询确保在较小屏幕上保持相同的比例关系

4. **动态计算**：
   - 在JavaScript中根据当前窗口尺寸动态计算元素位置和大小
   - 使用`SCREEN_RATIO`常量确保计算的一致性
   - `adjustWindowSizeForScreen`函数实现了基于当前屏幕宽度的智能尺寸计算

5. **图像适配**：
   - 所有图像资源使用高分辨率位图
   - 图片使用`max-width: 100%`和`height: auto`确保正确缩放
   - 图片位置使用百分比和`transform: translate()`定位，确保居中对齐

6. **统一的窗口尺寸调整逻辑**：
   - 新的`adjustWindowSizeForScreen`函数实现了基于当前屏幕宽度的智能尺寸计算
   - 预留10%的屏幕边距，防止窗口填满整个屏幕
   - 当计算出的高度超过屏幕可用高度时，会重新计算宽度以保持固定比例
   - 对不同模式应用不同的缩放因子，但保持相同的宽高比例

这些技术确保了应用在不同模式下都能按照正确的尺寸和比例显示，同时保持与目标物理屏幕的一致性，并且能够适应不同尺寸的显示设备。无论在开发调试阶段还是最终展示阶段，内容布局和视觉效果都能保持一致。

## 启动模式选择
应用启动时会显示一个模式选择对话框，用户需要选择运行模式：

1. **调试模式**：适用于开发人员进行界面调试和开发，窗口尺寸会根据9.05:1.80比例自动计算，默认高度为600px。
2. **产品模式**：适用于最终展示，窗口将设置为完整的物理屏幕尺寸（9050px × 1800px）。

用户的选择将决定应用的窗口尺寸和行为，确保在不同场景下都能获得最佳的使用体验。

## Git 忽略配置

项目包含一个 `.gitignore` 文件，用于配置 Git 忽略不需要版本控制的文件和文件夹。该文件已经配置了常见的忽略规则，包括：

- `node_modules/`：Node.js 依赖包
- `dist/`：构建输出目录
- `src/assets/*`：静态资源文件（除了 `.gitkeep` 文件）
- 日志文件、环境变量文件、IDE 配置文件等

这样可以确保只将必要的源代码和配置文件纳入版本控制，避免将不必要的文件提交到仓库中。

## 开发经验与问题解决

本项目在开发过程中遇到了一些技术挑战并成功解决，我们将这些经验记录在专门的文档中，供开发者参考：

- **[开发经验总结](docs/development-experiences.md)**：详细记录了GIF循环播放问题的分析与解决方案，包括事件时序控制、状态管理、异步操作处理等关键技术要点

这些文档包含了实际开发中遇到的技术难点、解决思路和完整的代码实现，对于理解项目架构和解决类似问题具有重要参考价值。